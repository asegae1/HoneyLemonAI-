<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>honeylemonai</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    :root { --primary: #FFD700; --accent: #FFA500; --bg: #fffdf0; }
    body { font-family: 'Segoe UI', Meiryo, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; color: #333; }
    
    /* Header & CSS Logo */
    .header { background: #fff; padding: 15px 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 10; }
    .logo { font-weight: 900; font-size: 26px; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; border-left: 8px solid var(--primary); padding-left: 15px; letter-spacing: -1px; }
    
    /* Chat Area */
    #chat-box { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
    .msg { max-width: 85%; padding: 14px 18px; border-radius: 20px; font-size: 15px; line-height: 1.7; position: relative; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .user { align-self: flex-end; background: linear-gradient(135deg, var(--accent), #ff8c00); color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 12px rgba(255,165,0,0.3); }
    .ai { align-self: flex-start; background: #fff; border: 1px solid #eee; border-bottom-left-radius: 4px; white-space: pre-wrap; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
    
    /* Media Styling */
    .img-preview { width: 100%; max-width: 450px; border-radius: 15px; margin-top: 12px; border: 4px solid var(--primary); transition: transform 0.3s; }
    .img-preview:hover { transform: scale(1.02); }
    .dl-btn { display: inline-flex; align-items: center; gap: 5px; margin-top: 10px; padding: 8px 16px; background: #4CAF50; color: white; text-decoration: none; border-radius: 30px; font-size: 13px; font-weight: bold; transition: 0.2s; }
    .dl-btn:hover { background: #45a049; }

    /* Input Area */
    .input-area { background: #fff; padding: 20px 30px; border-top: 1px solid #eee; box-shadow: 0 -5px 15px rgba(0,0,0,0.02); }
    #preview-zone { font-size: 13px; color: var(--accent); margin-bottom: 12px; font-weight: bold; display: none; }
    .controls { display: flex; gap: 12px; align-items: center; max-width: 1000px; margin: 0 auto; }
    
    .file-label { background: #f0f0f0; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-size: 22px; transition: 0.2s; }
    .file-label:hover { background: #e0e0e0; }
    
    select { border: 2px solid #eee; border-radius: 20px; padding: 10px 15px; outline: none; background: #fff; font-weight: bold; cursor: pointer; }
    input[type="text"] { flex: 1; padding: 14px 25px; border: 2px solid #eee; border-radius: 30px; outline: none; font-size: 15px; transition: 0.3s; }
    input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.1); }
    
    .send-btn { background: var(--primary); border: none; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(255,215,0,0.4); }
    .send-btn:hover { transform: rotate(10deg) scale(1.1); background: var(--accent); }
    .send-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
  </style>
</head>
<body>

<div class="header">
  <div class="logo">honeylemonai</div>
  <div id="status" style="font-size:11px; font-weight:bold; color:#aaa;">READY</div>
</div>

<div id="chat-box"></div>

<div class="input-area">
  <div id="preview-zone"></div>
  <div class="controls">
    <label class="file-label">üìé<input type="file" id="fileInput" style="display:none" onchange="handleFile()"></label>
    <select id="mode">
      <option value="chat">‰ºöË©±</option>
      <option value="image">ÂÜôÁúü„Çí‰Ωú„Çã</option>
    </select>
    <input id="input" type="text" placeholder="‰Ωï„Çí„ÅäÊâã‰ºù„ÅÑ„Åó„Åæ„Åó„Çá„ÅÜ„ÅãÔºü" autocomplete="off">
    <button class="send-btn" id="sendBtn" onclick="run()">üçã</button>
  </div>
</div>

<script>
  let currentFile = { name: "", data: "", text: "" };

  async function handleFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return;
    currentFile.name = file.name;
    const preview = document.getElementById('preview-zone');
    preview.style.display = "block";
    preview.innerText = `üìé ${file.name} „ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`;

    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => { currentFile.data = e.target.result; };
      reader.readAsDataURL(file);
    } else if (file.type === 'application/pdf') {
      const arrayBuffer = await file.arrayBuffer();
      const pdfjsLib = window['pdfjs-dist/build/pdf'];
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
      const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
      let t = "";
      for(let i=1; i<=Math.min(pdf.numPages, 5); i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        t += content.items.map(item => item.str).join(' ') + "\n";
      }
      currentFile.text = t;
    } else { currentFile.text = await file.text(); }
  }

  async function run() {
    const input = document.getElementById('input');
    const mode = document.getElementById('mode').value;
    const btn = document.getElementById('sendBtn');
    if (!input.value && !currentFile.name) return;

    addMsg(input.value || `${currentFile.name} „ÇíÈÄÅ‰ø°`, 'user');
    const fullPrompt = currentFile.text ? `„Äê„Éï„Ç°„Ç§„É´: ${currentFile.name}„Äë\n${currentFile.text}\n\nË≥™Âïè: ${input.value}` : input.value;
    const imageData = currentFile.data;

    input.value = "";
    document.getElementById('preview-zone').style.display = "none";
    btn.disabled = true;

    try {
      const endpoint = mode === 'image' ? '/api/image' : '/api/chat';
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: fullPrompt, image: imageData })
      });
      const data = await res.json();
      
      if (mode === 'image' && data.image) {
        const div = document.createElement('div');
        div.className = 'msg ai';
        div.innerHTML = `<div>ÁîüÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ</div><img src="${data.image}" class="img-preview"><br><a href="${data.image}" download="honeylemon_${Date.now()}.png" class="dl-btn">üì• ‰øùÂ≠ò„Åô„Çã</a>`;
        document.getElementById('chat-box').appendChild(div);
      } else {
        addMsg(data.content || data.error, 'ai');
      }
    } catch (e) { addMsg("ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ", 'ai'); }
    
    btn.disabled = false;
    currentFile = { name: "", data: "", text: "" };
    document.getElementById('fileInput').value = "";
    const b = document.getElementById('chat-box'); b.scrollTop = b.scrollHeight;
  }

  function addMsg(t, type) {
    const b = document.getElementById('chat-box');
    const d = document.createElement('div');
    d.className = `msg ${type}`; d.innerText = t;
    b.appendChild(d); b.scrollTop = b.scrollHeight;
  }
  document.getElementById('input').addEventListener('keypress', (e) => { if(e.key === 'Enter' && !document.getElementById('sendBtn').disabled) run(); });
</script>
</body>
</html>
